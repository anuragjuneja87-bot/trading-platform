<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamma Levels Detail View - 0DTE Zones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #000000;
            color: #00ff00;
            padding: 15px;
            font-size: 13px;
            overflow-x: auto;
        }

        .header {
            background: #0a0a0a;
            padding: 20px;
            border: 2px solid #ff00ff;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #ff00ff;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px #ff00ff;
        }

        .header-right {
            text-align: right;
        }

        .market-time {
            font-size: 18px;
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .update-indicator {
            font-size: 12px;
            color: #00ff00;
            padding: 6px 12px;
            border: 1px solid #00ff00;
            border-radius: 3px;
            display: inline-block;
        }

        .update-indicator.updating {
            color: #ffff00;
            border-color: #ffff00;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .watchlist-info {
            font-size: 11px;
            color: #888;
            margin-top: 8px;
        }

        .table-container {
            overflow-x: auto;
            border: 2px solid #ff00ff;
            background: #0a0a0a;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th {
            background: #1a001a;
            color: #ff00ff;
            padding: 15px 10px;
            text-align: center;
            font-size: 12px;
            text-transform: uppercase;
            border: 1px solid #ff00ff;
            white-space: nowrap;
            font-weight: bold;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 8px;
            border: 1px solid #330033;
            text-align: center;
            vertical-align: top;
        }

        tr:nth-child(even) {
            background: #0f0f0f;
        }

        tr:nth-child(odd) {
            background: #0a0a0a;
        }

        tr:hover {
            background: #1a1a1a;
        }

        tr.zero-dte {
            animation: blinkRow 2s infinite;
        }

        @keyframes blinkRow {
            0%, 100% { background: #0a0a0a; }
            50% { background: #2a2a00; }
        }

        .symbol {
            font-weight: bold;
            font-size: 18px;
            color: #ffffff;
            letter-spacing: 1px;
        }

        .price {
            font-weight: bold;
            font-size: 16px;
            color: #ffff00;
        }

        .expiration {
            font-size: 11px;
            color: #888;
        }

        .zero-dte-status {
            font-size: 14px;
            font-weight: bold;
            color: #ff00ff;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.4; }
        }

        .gamma-cell {
            line-height: 1.6;
            min-width: 140px;
        }

        .strike-price {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .resistance-1 .strike-price {
            color: #ff3333;
        }

        .resistance-2 .strike-price {
            color: #ff8833;
        }

        .support-1 .strike-price {
            color: #33ff33;
        }

        .support-2 .strike-price {
            color: #33ff88;
        }

        .oi-volume {
            font-size: 11px;
            color: #aaa;
            margin-bottom: 3px;
        }

        .resistance-1 .oi-volume {
            color: #ff9999;
        }

        .resistance-2 .oi-volume {
            color: #ffbb88;
        }

        .support-1 .oi-volume {
            color: #99ff99;
        }

        .support-2 .oi-volume {
            color: #99ffbb;
        }

        .distance {
            font-size: 10px;
            color: #666;
            font-style: italic;
        }

        .strength-strong {
            text-shadow: 0 0 8px currentColor;
            font-weight: bold;
        }

        .expected-range {
            font-size: 13px;
            color: #00ccff;
            font-weight: bold;
        }

        .data-source {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            display: inline-block;
        }

        .source-tradier {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .source-fallback {
            background: #332200;
            color: #ff9900;
            border: 1px solid #ff9900;
        }

        .no-data {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #ffff00;
        }

        .emoji {
            font-size: 14px;
            margin-right: 3px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>⚡ GAMMA LEVELS DETAIL VIEW - 0DTE ZONES ⚡</h1>
            <div class="watchlist-info" id="symbolList">Loading watchlist...</div>
        </div>
        <div class="header-right">
            <div class="market-time" id="marketTime">--:--:-- ET</div>
            <span class="update-indicator" id="updateIndicator">Auto-refresh: 30s</span>
        </div>
    </div>

    <div class="table-container">
        <table id="gammaTable">
            <thead>
                <tr>
                    <th>SYMBOL</th>
                    <th>CURRENT<br>PRICE</th>
                    <th>EXPIRATION</th>
                    <th>0DTE<br>STATUS</th>
                    <th style="background: #330000;">RESISTANCE 1<br><small style="opacity:0.7;">Closest Above</small></th>
                    <th style="background: #331100;">RESISTANCE 2<br><small style="opacity:0.7;">Second Above</small></th>
                    <th style="background: #003300;">SUPPORT 1<br><small style="opacity:0.7;">Closest Below</small></th>
                    <th style="background: #003311;">SUPPORT 2<br><small style="opacity:0.7;">Second Below</small></th>
                    <th>EXPECTED<br>RANGE</th>
                    <th>DATA<br>SOURCE</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="10" class="loading">LOADING GAMMA DATA...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let SYMBOLS = [];
        const API_BASE = 'http://localhost:5001/api';

        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/watchlist`);
                const data = await response.json();
                
                if (data.symbols && data.symbols.length > 0) {
                    SYMBOLS = data.symbols;
                    document.getElementById('symbolList').textContent = `Tracking ${SYMBOLS.length} symbols: ${SYMBOLS.join(', ')}`;
                    console.log(`✅ Loaded ${SYMBOLS.length} symbols from watchlist`);
                    return true;
                } else {
                    SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                    document.getElementById('symbolList').textContent = `Using default symbols: ${SYMBOLS.join(', ')}`;
                    return false;
                }
            } catch (error) {
                console.error('❌ Error loading watchlist:', error);
                SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                return false;
            }
        }

        function updateTime() {
            const now = new Date();
            const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const timeStr = et.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('marketTime').textContent = timeStr + ' ET';
        }

        function formatPrice(price) {
            return price > 0 ? `$${price.toFixed(2)}` : '--';
        }

        function formatGammaLevel(level) {
            if (!level) {
                return '<div class="no-data">No wall detected</div>';
            }

            const oiK = (level.total_oi / 1000).toFixed(1);
            const volK = (level.total_volume / 1000).toFixed(1);
            const emoji = level.strength === 'STRONG' ? '●' : level.strength === 'MODERATE' ? '◐' : '○';
            const strengthClass = level.strength === 'STRONG' ? 'strength-strong' : '';

            return `
                <div class="strike-price ${strengthClass}">
                    <span class="emoji">${emoji}</span>${formatPrice(level.strike)}
                </div>
                <div class="oi-volume">
                    OI: ${oiK}K | Vol: ${volK}K
                </div>
                <div class="distance">
                    ${level.direction} ${Math.abs(level.distance_pct).toFixed(1)}%
                </div>
            `;
        }

        function createRow(data) {
            const oi = data.open_interest || {};
            
            if (!oi.available || !oi.gamma_levels || oi.gamma_levels.length === 0) {
                return `
                    <tr>
                        <td><div class="symbol">${data.symbol}</div></td>
                        <td><div class="price">${formatPrice(data.current_price)}</div></td>
                        <td colspan="8" class="no-data">No gamma data available</td>
                    </tr>
                `;
            }

            const levels = oi.gamma_levels;
            const currentPrice = oi.current_price || data.current_price;
            
            // Sort and find levels
            const sortedLevels = [...levels].sort((a, b) => b.strike - a.strike);
            const resistance = sortedLevels.filter(l => l.strike > currentPrice);
            const support = sortedLevels.filter(l => l.strike <= currentPrice);

            const res1 = resistance[0] || null;
            const res2 = resistance[1] || null;
            const sup1 = support[0] || null;
            const sup2 = support[1] || null;

            // 0DTE status
            let zeroDTEStatus = '<div class="no-data">--</div>';
            let rowClass = '';
            
            if (oi.expires_today && oi.hours_until_expiry > 0) {
                zeroDTEStatus = `<div class="zero-dte-status">⏰ ${oi.hours_until_expiry.toFixed(1)}h LEFT</div>`;
                rowClass = 'zero-dte';
            } else if (oi.expires_today) {
                zeroDTEStatus = '<div class="zero-dte-status">🔴 EXPIRED</div>';
            }

            // Expiration
            const expiration = oi.expiration || '--';
            const expDisplay = `<div class="expiration">${expiration}</div>`;

            // Expected range
            const rangeDisplay = oi.expected_range ? 
                `<div class="expected-range">${formatPrice(oi.expected_range.low)}<br>to<br>${formatPrice(oi.expected_range.high)}</div>` :
                '<div class="no-data">--</div>';

            // Data source
            const source = oi.data_source || 'unknown';
            const sourceClass = source === 'tradier' ? 'source-tradier' : 'source-fallback';
            const sourceText = source === 'tradier' ? '📡 Tradier' : '⚠️ Fallback';
            const sourceDisplay = `<div class="data-source ${sourceClass}">${sourceText}</div>`;

            return `
                <tr class="${rowClass}">
                    <td><div class="symbol">${data.symbol}</div></td>
                    <td><div class="price">${formatPrice(currentPrice)}</div></td>
                    <td>${expDisplay}</td>
                    <td>${zeroDTEStatus}</td>
                    <td class="gamma-cell resistance-1">${formatGammaLevel(res1)}</td>
                    <td class="gamma-cell resistance-2">${formatGammaLevel(res2)}</td>
                    <td class="gamma-cell support-1">${formatGammaLevel(sup1)}</td>
                    <td class="gamma-cell support-2">${formatGammaLevel(sup2)}</td>
                    <td>${rangeDisplay}</td>
                    <td>${sourceDisplay}</td>
                </tr>
            `;
        }

        async function loadData() {
            if (SYMBOLS.length === 0) {
                console.log('⏳ Waiting for watchlist to load...');
                return;
            }

            const indicator = document.getElementById('updateIndicator');
            indicator.textContent = 'Updating...';
            indicator.classList.add('updating');

            try {
                const promises = SYMBOLS.map(symbol => 
                    fetch(`${API_BASE}/analyze/${symbol}`)
                        .then(r => r.json())
                        .catch(e => ({ symbol, error: e.message }))
                );

                const results = await Promise.all(promises);
                
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = results
                    .filter(data => !data.error)
                    .map(data => createRow(data))
                    .join('');

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                indicator.textContent = `Last update: ${timeStr}`;
                indicator.classList.remove('updating');

            } catch (error) {
                console.error('Error loading data:', error);
                indicator.textContent = 'Update failed';
                indicator.classList.remove('updating');
            }
        }

        async function initialize() {
            console.log('🚀 Initializing Gamma Levels Detail View');
            
            await loadWatchlist();
            
            setInterval(updateTime, 1000);
            updateTime();

            await loadData();
            
            // Auto-refresh every 30 seconds
            setInterval(loadData, 30000);
            
            console.log('✅ Gamma detail view initialized with', SYMBOLS.length, 'symbols');
        }

        initialize();
    </script>
</body>
</html>
