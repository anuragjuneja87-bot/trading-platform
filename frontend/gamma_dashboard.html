<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamma Levels Dashboard v2.0 - With Max Pain & Pin Probability</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #000000;
            color: #00ff00;
            padding: 15px;
            font-size: 13px;
            overflow-x: auto;
        }

        .header {
            background: #0a0a0a;
            padding: 20px;
            border: 2px solid #ff00ff;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #ff00ff;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 10px #ff00ff;
        }

        .table-container {
            overflow-x: auto;
            border: 2px solid #ff00ff;
            background: #0a0a0a;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th {
            background: #1a001a;
            color: #ff00ff;
            padding: 12px 6px;
            text-align: center;
            font-size: 11px;
            text-transform: uppercase;
            border: 1px solid #ff00ff;
            white-space: nowrap;
            font-weight: bold;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px 6px;
            border: 1px solid #330033;
            text-align: center;
            vertical-align: top;
        }

        tr:nth-child(even) {
            background: #0f0f0f;
        }

        tr:nth-child(odd) {
            background: #0a0a0a;
        }

        tr:hover {
            background: #1a1a1a;
        }

        .symbol {
            font-weight: bold;
            font-size: 18px;
            color: #ffffff;
            letter-spacing: 1px;
        }

        .price {
            font-weight: bold;
            font-size: 16px;
            color: #ffff00;
        }

        .zero-dte-status {
            font-size: 14px;
            font-weight: bold;
            color: #ff00ff;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.4; }
        }

        .gamma-cell {
            line-height: 1.5;
            min-width: 110px;
            font-size: 11px;
        }

        .strike-price {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
            letter-spacing: 0.3px;
        }

        .resistance-1 .strike-price {
            color: #ff3333;
        }

        .resistance-2 .strike-price {
            color: #ff8833;
        }

        .support-1 .strike-price {
            color: #33ff33;
        }

        .support-2 .strike-price {
            color: #33ff88;
        }

        .oi-volume {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 2px;
        }

        /* NEW: Wall Strength Styles */
        .wall-strength-cell {
            min-width: 160px;
            line-height: 1.4;
            text-align: left;
            font-size: 10px;
        }

        /* NEW: Max Pain Column Styles */
        .max-pain-cell {
            min-width: 110px;
            text-align: center;
            vertical-align: middle;
            background: #0f0a0f;
            padding: 8px;
        }

        /* NEW: Pin Probability Column Styles */
        .pin-probability-cell {
            min-width: 100px;
            text-align: center;
            vertical-align: middle;
            background: #0a0f0f;
            padding: 8px;
        }

        /* Wall Status Animations */
        @keyframes pulse-orange {
            0%, 100% { box-shadow: 0 0 5px #ff6600; background: #221100; }
            50% { box-shadow: 0 0 20px #ff6600; background: #331100; }
        }

        @keyframes flash-yellow {
            0%, 100% { background: #1a1a00; }
            50% { background: #333300; }
        }

        @keyframes flash-red {
            0%, 100% { background: #1a0000; }
            50% { background: #330000; }
        }

        @keyframes glow-green {
            0%, 100% { box-shadow: 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00; }
        }

        .wall-building {
            animation: pulse-orange 2s infinite;
            color: #ff6600;
            font-weight: bold;
            padding: 6px;
            border-radius: 3px;
            margin: 3px 0;
        }

        .wall-weakening {
            animation: flash-yellow 1.5s infinite;
            color: #ffff00;
            font-weight: bold;
            padding: 6px;
            border-radius: 3px;
            margin: 3px 0;
        }

        .wall-breaking {
            animation: flash-red 1s infinite;
            color: #ff0000;
            font-weight: bold;
            padding: 6px;
            border-radius: 3px;
            margin: 3px 0;
        }

        .wall-strong {
            animation: glow-green 3s infinite;
            color: #00ff00;
            font-weight: bold;
            padding: 6px;
            border-radius: 3px;
            margin: 3px 0;
        }

        .wall-stable {
            color: #666666;
        }

        /* Proximity Alert Animations */
        @keyframes flash-red-urgent {
            0%, 100% { background: #330000; box-shadow: 0 0 20px #ff0000; }
            50% { background: #660000; box-shadow: 0 0 40px #ff0000; }
        }

        @keyframes pulse-yellow-warning {
            0%, 100% { background: #1a1a00; box-shadow: 0 0 15px #ffff00; }
            50% { background: #333300; box-shadow: 0 0 30px #ffff00; }
        }

        @keyframes glow-green-approach {
            0%, 100% { background: #001a00; box-shadow: 0 0 10px #00ff00; }
            50% { background: #002200; box-shadow: 0 0 20px #00ff00; }
        }

        tr.proximity-critical {
            animation: flash-red-urgent 0.8s infinite;
        }

        tr.proximity-warning {
            animation: pulse-yellow-warning 1.5s infinite;
        }

        tr.proximity-approaching {
            animation: glow-green-approach 2.5s infinite;
        }

        .distance-critical {
            font-size: 14px !important;
            font-weight: bold !important;
            color: #ff0000 !important;
            animation: flash-red-urgent 0.8s infinite;
        }

        .distance-warning {
            font-size: 13px !important;
            font-weight: bold !important;
            color: #ffff00 !important;
        }

        .distance-approaching {
            font-size: 12px !important;
            color: #00ff00 !important;
        }

        .timeline-entry {
            font-size: 10px;
            margin: 2px 0;
            padding: 2px 4px;
            background: #1a1a1a;
            border-radius: 2px;
        }

        .timeline-entry.building {
            background: #002200;
            color: #00ff00;
        }

        .timeline-entry.weakening {
            background: #220000;
            color: #ff6600;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 18px;
            color: #ffff00;
        }

        /* Responsive scaling for smaller screens */
        @media (max-width: 1600px) {
            table {
                min-width: 1200px;
                font-size: 11px;
            }
            
            th {
                padding: 10px 4px;
                font-size: 10px;
            }
            
            td {
                padding: 8px 4px;
            }
            
            .gamma-cell {
                min-width: 90px;
            }
            
            .wall-strength-cell {
                min-width: 130px;
                font-size: 9px;
            }
            
            .max-pain-cell, .pin-probability-cell {
                min-width: 85px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>‚ö° GAMMA LEVELS + WALL STRENGTH TRACKER ‚ö°</h1>
            <div style="font-size: 10px; color: #666; margin-top: 4px;" id="symbolList">Loading watchlist...</div>
        </div>
        <div style="text-align: right;">
            <div class="market-time" style="font-size: 18px; color: #ffff00; font-weight: bold; margin-bottom: 8px;" id="marketTime">--:--:-- ET</div>
            <span style="font-size: 12px; color: #00ff00; padding: 6px 12px; border: 1px solid #00ff00; border-radius: 3px;" id="updateIndicator">Auto-refresh: 15s</span>
        </div>
    </div>

    <div class="table-container">
        <table id="gammaTable">
            <thead>
                <tr>
                    <th>SYMBOL</th>
                    <th>CURRENT<br>PRICE</th>
                    <th>EXPIRATION</th>
                    <th>0DTE<br>STATUS</th>
                    <th style="background: #330000;">RESISTANCE 1</th>
                    <th style="background: #331100;">RESISTANCE 2</th>
                    <th style="background: #003300;">SUPPORT 1</th>
                    <th style="background: #003311;">SUPPORT 2</th>
                    <th style="background: #1a001a;">WALL STRENGTH üî•<br><small style="opacity:0.7;">OI Changes</small></th>
                    <th style="background: #440044;">MAX PAIN üéØ<br><small style="opacity:0.7;">Target Price</small></th>
                    <th style="background: #004444;">PIN %<br><small style="opacity:0.7;">Probability</small></th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="11" class="loading">LOADING GAMMA DATA...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let SYMBOLS = [];
        const API_BASE = 'http://localhost:5001/api';

        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/watchlist`);
                const data = await response.json();
                
                if (data.watchlist && data.watchlist.length > 0) {
                    SYMBOLS = data.watchlist;
                    document.getElementById('symbolList').textContent = `Tracking ${SYMBOLS.length} symbols: ${SYMBOLS.join(', ')}`;
                    return true;
                } else {
                    SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                    document.getElementById('symbolList').textContent = `Using default symbols: ${SYMBOLS.join(', ')}`;
                    return false;
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
                SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                return false;
            }
        }

        function updateTime() {
            const now = new Date();
            const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const timeStr = et.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('marketTime').textContent = timeStr + ' ET';
        }

        function formatPrice(price) {
            return price > 0 ? `$${price.toFixed(2)}` : '--';
        }

        function formatGammaLevel(level) {
            if (!level) {
                return '<div style="color: #666;">No wall detected</div>';
            }

            const oiK = (level.total_oi / 1000).toFixed(1);
            const volK = (level.total_volume / 1000).toFixed(1);
            const emoji = level.strength === 'STRONG' ? '‚óÜ' : level.strength === 'MODERATE' ? '‚óá' : '‚óã';

            return `
                <div class="strike-price">
                    <span style="font-size: 14px;">${emoji}</span> ${formatPrice(level.strike)}
                </div>
                <div class="oi-volume">
                    OI: ${oiK}K | Vol: ${volK}K
                </div>
                <div style="font-size: 9px; color: #777;">
                    ${level.direction} ${Math.abs(level.distance_pct).toFixed(1)}%
                </div>
            `;
        }

        function formatMaxPain(maxPain, currentPrice) {
            /**
             * Format Max Pain display
             * Shows target price and distance from current
             */
            const distance = currentPrice - maxPain;
            const distancePct = (distance / currentPrice) * 100;
            const direction = distance > 0 ? '‚Üì' : '‚Üë';
            const directionColor = distance > 0 ? '#ff6666' : '#66ff66';
            
            return `
                <div style="text-align: center;">
                    <div style="font-size: 16px; font-weight: bold; color: #ff00ff; margin-bottom: 4px;">
                        $${maxPain.toFixed(2)}
                    </div>
                    <div style="font-size: 11px; color: ${directionColor}; font-weight: bold;">
                        ${direction} ${Math.abs(distancePct).toFixed(1)}% away
                    </div>
                    <div style="font-size: 9px; color: #888; margin-top: 2px;">
                        Current: $${currentPrice.toFixed(2)}
                    </div>
                </div>
            `;
        }

        function formatPinProbability(pinProbability, hoursUntilExpiry) {
            /**
             * Format Pin Probability display
             * Shows percentage and strength indicator
             */
            const pinPct = pinProbability.percent || 0;
            const strength = pinProbability.strength || 'UNKNOWN';
            
            // Color based on probability
            let pinColor = '#888888';
            let strengthEmoji = '‚óã';
            
            if (pinPct >= 75) {
                pinColor = '#00ff00';
                strengthEmoji = '‚óÜ‚óÜ‚óÜ';
            } else if (pinPct >= 60) {
                pinColor = '#ffff00';
                strengthEmoji = '‚óÜ‚óÜ';
            } else if (pinPct >= 45) {
                pinColor = '#ff9900';
                strengthEmoji = '‚óÜ';
            } else {
                pinColor = '#666666';
                strengthEmoji = '‚óã';
            }
            
            return `
                <div style="text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: ${pinColor}; margin-bottom: 4px;">
                        ${pinPct.toFixed(0)}%
                    </div>
                    <div style="font-size: 11px; color: ${pinColor}; font-weight: bold;">
                        ${strengthEmoji}
                    </div>
                    <div style="font-size: 10px; color: #888; margin-top: 2px;">
                        ${strength}
                    </div>
                    ${hoursUntilExpiry ? `<div style="font-size: 9px; color: #666; margin-top: 2px;">${hoursUntilExpiry.toFixed(1)}h left</div>` : ''}
                </div>
            `;
        }

        function formatWallStrength(wallStrength, currentPrice) {
            if (!wallStrength || !wallStrength.tracked_walls || wallStrength.tracked_walls.length === 0) {
                return '<div style="color: #666; font-size: 11px; padding: 10px;">No walls tracked</div>';
            }

            const walls = wallStrength.tracked_walls;
            
            // Sort by absolute OI change percentage (most significant first)
            const sortedWalls = [...walls]
                .filter(w => w.status !== 'STABLE')
                .sort((a, b) => Math.abs(b.oi_change_pct) - Math.abs(a.oi_change_pct))
                .slice(0, 3); // Show top 3

            if (sortedWalls.length === 0) {
                return '<div style="color: #666; font-size: 11px; padding: 10px;">All walls stable</div>';
            }

            let html = '';
            
            for (const wall of sortedWalls) {
                const distance = ((wall.strike - currentPrice) / currentPrice) * 100;
                const distanceStr = `${Math.abs(distance).toFixed(1)}% ${distance > 0 ? 'above' : 'below'}`;
                
                // Status-based styling
                let statusClass = 'wall-stable';
                let emoji = '‚óã';
                
                if (wall.status === 'BUILDING') {
                    statusClass = 'wall-building';
                    emoji = 'üî•';
                } else if (wall.status === 'WEAKENING') {
                    statusClass = 'wall-weakening';
                    emoji = '‚ö†Ô∏è';
                } else if (wall.status === 'BREAKING') {
                    statusClass = 'wall-breaking';
                    emoji = 'üí•';
                } else if (wall.status === 'STRONG') {
                    statusClass = 'wall-strong';
                    emoji = '‚úÖ';
                }
                
                html += `
                    <div class="${statusClass}" style="margin-bottom: 6px; font-size: 11px; line-height: 1.4;">
                        <div style="font-size: 13px; font-weight: bold; margin-bottom: 2px;">
                            ${emoji} $${wall.strike.toFixed(2)} ${wall.type}
                        </div>
                        <div style="font-size: 12px; opacity: 0.95;">
                            ${wall.status} ${wall.oi_change_pct > 0 ? '+' : ''}${wall.oi_change_pct.toFixed(0)}%
                        </div>
                        <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">
                            OI: ${wall.current_oi.toLocaleString()} (was ${wall.baseline_oi.toLocaleString()})
                        </div>
                        <div style="font-size: 10px; opacity: 0.7; margin-top: 2px;">
                            üìç ${distanceStr}
                        </div>
                    </div>
                `;
            }

            return html;
        }

        function checkProximity(currentPrice, levels) {
            /**
             * Check proximity to gamma walls
             * Returns: {class: 'proximity-X', closestWall: strike, distance: pct}
             */
            if (!levels || levels.length === 0) {
                return { class: '', closestWall: null, distance: null };
            }

            let minDistance = Infinity;
            let closestWall = null;

            for (const level of levels) {
                if (!level || !level.strike) continue;
                const distance = Math.abs(((level.strike - currentPrice) / currentPrice) * 100);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestWall = level.strike;
                }
            }

            // Proximity thresholds - TIGHTENED (only flash when VERY close)
            if (minDistance <= 0.3) {
                return { class: 'proximity-critical', closestWall, distance: minDistance, level: 'CRITICAL' };
            } else if (minDistance <= 0.6) {
                return { class: 'proximity-warning', closestWall, distance: minDistance, level: 'WARNING' };
            }

            return { class: '', closestWall, distance: minDistance, level: 'SAFE' };
        }

        function createRow(data) {
            const oi = data.open_interest || {};
            
            if (!oi.available || !oi.gamma_levels || oi.gamma_levels.length === 0) {
                return `
                    <tr>
                        <td><div class="symbol">${data.symbol}</div></td>
                        <td><div class="price">${formatPrice(data.current_price)}</div></td>
                        <td colspan="9" style="color: #666;">No gamma data available</td>
                    </tr>
                `;
            }

            const levels = oi.gamma_levels;
            const currentPrice = oi.current_price || data.current_price;
            
            // Sort and find levels
            const sortedLevels = [...levels].sort((a, b) => b.strike - a.strike);
            const resistance = sortedLevels.filter(l => l.strike > currentPrice);
            const support = sortedLevels.filter(l => l.strike <= currentPrice);

            const res1 = resistance[0] || null;
            const res2 = resistance[1] || null;
            const sup1 = support[0] || null;
            const sup2 = support[1] || null;

            // 0DTE status
            let zeroDTEStatus = '<div style="color: #666;">--</div>';
            
            if (oi.expires_today && oi.hours_until_expiry > 0) {
                zeroDTEStatus = `<div class="zero-dte-status">‚è∞ ${oi.hours_until_expiry.toFixed(1)}h LEFT</div>`;
            } else if (oi.expires_today) {
                zeroDTEStatus = '<div class="zero-dte-status">üî¥ EXPIRED</div>';
            }

            // Expiration
            const expiration = oi.expiration || '--';
            const expDisplay = `<div style="font-size: 11px;">${expiration}</div>`;

            // Wall Strength
            const wallStrength = data.wall_strength || {};
            const wallDisplay = formatWallStrength(wallStrength, currentPrice);

            // Max Pain (from pin_analysis)
            const pinAnalysis = data.pin_analysis || {};
            const maxPain = pinAnalysis.max_pain || 0;
            const maxPainDisplay = maxPain > 0 ? formatMaxPain(maxPain, currentPrice) : '<div style="color: #666;">No data</div>';

            // Pin Probability
            const pinProbability = pinAnalysis.pin_probability || {};
            const pinPct = pinProbability.percent || 0;
            const pinDisplay = pinPct > 0 ? formatPinProbability(pinProbability, oi.hours_until_expiry) : '<div style="color: #666;">No data</div>';

            // Check proximity to gamma walls
            const allLevels = [res1, res2, sup1, sup2].filter(l => l !== null);
            const proximity = checkProximity(currentPrice, allLevels);
            
            // Proximity alert badge
            let proximityBadge = '';
            if (proximity.level === 'CRITICAL') {
                proximityBadge = `<div style="position: absolute; top: 5px; right: 5px; background: #ff0000; color: #000; padding: 4px 8px; font-size: 11px; font-weight: bold; border-radius: 3px; animation: flash-red-urgent 0.8s infinite;">üö® ${proximity.distance.toFixed(2)}% TO $${proximity.closestWall.toFixed(2)}</div>`;
            } else if (proximity.level === 'WARNING') {
                proximityBadge = `<div style="position: absolute; top: 5px; right: 5px; background: #ffff00; color: #000; padding: 4px 8px; font-size: 11px; font-weight: bold; border-radius: 3px;">‚ö†Ô∏è ${proximity.distance.toFixed(2)}% TO $${proximity.closestWall.toFixed(2)}</div>`;
            }

            return `
                <tr class="${proximity.class}" style="position: relative;">
                    <td><div class="symbol">${data.symbol}</div>${proximityBadge}</td>
                    <td><div class="price">${formatPrice(currentPrice)}</div></td>
                    <td>${expDisplay}</td>
                    <td>${zeroDTEStatus}</td>
                    <td class="gamma-cell resistance-1">${formatGammaLevel(res1)}</td>
                    <td class="gamma-cell resistance-2">${formatGammaLevel(res2)}</td>
                    <td class="gamma-cell support-1">${formatGammaLevel(sup1)}</td>
                    <td class="gamma-cell support-2">${formatGammaLevel(sup2)}</td>
                    <td class="wall-strength-cell">${wallDisplay}</td>
                    <td class="max-pain-cell">${maxPainDisplay}</td>
                    <td class="pin-probability-cell">${pinDisplay}</td>
                </tr>
            `;
        }

        async function loadData() {
            if (SYMBOLS.length === 0) {
                console.log('‚è≥ Waiting for watchlist to load...');
                return;
            }

            const indicator = document.getElementById('updateIndicator');
            indicator.textContent = 'Updating...';

            try {
                const promises = SYMBOLS.map(symbol => 
                    fetch(`${API_BASE}/analyze/${symbol}`)
                        .then(r => r.json())
                        .catch(e => ({ symbol, error: e.message }))
                );

                const results = await Promise.all(promises);
                
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = results
                    .filter(data => !data.error)
                    .map(data => createRow(data))
                    .join('');

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                indicator.textContent = `Last update: ${timeStr}`;

            } catch (error) {
                console.error('Error loading data:', error);
                indicator.textContent = 'Update failed';
            }
        }

        async function initialize() {
            console.log('üöÄ Initializing Gamma Levels + Wall Strength View');
            
            await loadWatchlist();
            
            setInterval(updateTime, 1000);
            updateTime();

            await loadData();
            
            // Auto-refresh every 15 seconds
            setInterval(loadData, 15000);
            
            console.log('‚úÖ Gamma + Wall Strength view initialized');
        }

        initialize();
    </script>
</body>
</html>