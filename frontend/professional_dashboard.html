<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Trading Dashboard v5.0 - OPTIMIZED FOR DAY TRADING</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #000000;
            color: #00ff00;
            padding: 10px;
            font-size: 12px;
        }

        .header {
            background: #0a0a0a;
            padding: 15px;
            border: 1px solid #00ff00;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            color: #00ff00;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sound-toggle, .earnings-toggle {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            border-radius: 3px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover, .earnings-toggle:hover {
            background: #004400;
        }

        .sound-toggle.active {
            background: #00ff00;
            color: #000;
        }

        .earnings-toggle {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .earnings-toggle.disabled {
            background: #332200;
            color: #ff6600;
            border-color: #ff6600;
        }

        .notification-status {
            font-size: 10px;
            color: #ffff00;
            padding: 4px 8px;
            border: 1px solid #ffff00;
            border-radius: 3px;
            cursor: pointer;
        }

        .notification-status.enabled {
            color: #00ff00;
            border-color: #00ff00;
        }

        .market-time {
            font-size: 14px;
            color: #ffff00;
        }

        .market-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: bold;
        }

        .market-status.open {
            background: #00ff00;
            color: #000;
        }

        .market-status.closed {
            background: #ff0000;
            color: #fff;
        }

        .update-indicator {
            font-size: 10px;
            color: #666;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .update-indicator.updating {
            color: #ffff00;
            animation: pulse 1s infinite;
        }

        .watchlist-info {
            font-size: 10px;
            color: #00ccff;
            padding: 4px 8px;
            border: 1px solid #00ccff;
            border-radius: 3px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #00ff00;
        }

        /* Live Greeks Panel */
        .live-greeks-panel {
            background: #0a0a0a;
            border: 2px solid #ff00ff;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
        }

        .live-greeks-panel h2 {
            color: #ff00ff;
            font-size: 16px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }

        .greeks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 10px;
        }

        .greek-card {
            background: #1a001a;
            border: 1px solid #ff00ff;
            padding: 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .greek-card:hover {
            background: #2a002a;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
        }

        .greek-card .symbol {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .greek-card .price {
            font-size: 14px;
            color: #ffff00;
            margin-bottom: 8px;
        }

        .greek-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .greek-stat {
            text-align: center;
        }

        .greek-stat-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
        }

        .greek-stat-value {
            font-size: 14px;
            font-weight: bold;
            color: #00ff00;
        }

        .delta-change {
            font-size: 11px;
            margin-top: 2px;
        }

        .delta-up {
            color: #00ff00;
        }

        .delta-down {
            color: #ff0000;
        }

        .delta-neutral {
            color: #ffff00;
        }

        .wall-alert {
            background: #ff00ff;
            color: #000;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-top: 6px;
            text-align: center;
            animation: pulseWall 1.5s infinite;
        }

        @keyframes pulseWall {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #0a0a0a;
        }

        th {
            background: #001a00;
            color: #00ff00;
            padding: 8px 6px;
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            border: 1px solid #00ff00;
            white-space: nowrap;
        }

        td {
            padding: 6px;
            border: 1px solid #003300;
            font-size: 11px;
            white-space: nowrap;
            transition: background-color 0.3s ease;
        }

        tr:hover {
            background: #001a00;
        }

        .value-changed {
            animation: flashValue 0.5s ease-in-out;
        }

        @keyframes flashValue {
            0%, 100% { background-color: transparent; }
            50% { background-color: #1a3300; }
        }

        .alert-changed {
            animation: flashAlert 1s ease-in-out 2;
        }

        @keyframes flashAlert {
            0%, 100% { 
                box-shadow: 0 0 0px rgba(255, 255, 0, 0);
            }
            50% { 
                box-shadow: 0 0 15px rgba(255, 255, 0, 0.8);
            }
        }

        .symbol {
            font-weight: bold;
            font-size: 14px;
            color: #ffffff;
        }

        .price {
            font-weight: bold;
            color: #ffff00;
        }

        /* NEW: VWAP Styles */
        .vwap-price {
            font-weight: bold;
            color: #00ccff;
            font-size: 12px;
        }

        .vwap-distance {
            font-size: 11px;
            font-weight: bold;
        }

        .vwap-above {
            color: #ff6666; /* Above VWAP = bearish for mean reversion */
        }

        .vwap-below {
            color: #66ff66; /* Below VWAP = bullish for mean reversion */
        }

        .vwap-neutral {
            color: #ffff00; /* At VWAP */
        }

        /* NEW: Momentum Styles */
        .momentum-cell {
            font-size: 16px;
            text-align: center;
            font-weight: bold;
        }

        .momentum-bullish {
            color: #00ff00;
        }

        .momentum-bearish {
            color: #ff0000;
        }

        .momentum-neutral {
            color: #888888;
        }

        .momentum-arrow {
            display: inline-block;
            margin: 0 2px;
        }

        .bullish {
            color: #00ff00;
            font-weight: bold;
        }

        .bearish {
            color: #ff0000;
            font-weight: bold;
        }

        .neutral {
            color: #888888;
        }

        .alert-buy {
            background: #003300;
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
        }

        .alert-sell {
            background: #330000;
            color: #ff0000;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
        }

        .alert-tp {
            background: #333300;
            color: #ffff00;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
            animation: blink 1s infinite;
        }

        .alert-monitor {
            color: #666666;
            padding: 4px 8px;
        }

        .alert-extreme {
            background: #330000;
            color: #ff0000;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
            animation: blink 0.5s infinite;
            border: 2px solid #ff0000;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .level {
            font-family: monospace;
            color: #00ccff;
        }

        .news-positive, .news-very.positive {
            color: #00ff00;
        }

        .news-negative, .news-very.negative {
            color: #ff0000;
        }

        .news-neutral {
            color: #888888;
        }

        .institutional-buying {
            color: #00ff00;
            font-weight: bold;
        }

        .institutional-selling {
            color: #ff0000;
            font-weight: bold;
        }

        .institutional-neutral, .institutional-mixed {
            color: #888888;
        }

        .confidence {
            font-weight: bold;
        }

        .confidence.high {
            color: #00ff00;
        }

        .confidence.medium {
            color: #ffff00;
        }

        .confidence.low {
            color: #ff6600;
        }

        .entry-targets {
            font-size: 10px;
            color: #00ccff;
            line-height: 1.4;
        }

        .volume-unknown {
            color: #666;
        }

        .volume-low {
            color: #888;
        }

        .volume-elevated {
            color: #ffff00;
            font-weight: bold;
        }

        .volume-high {
            color: #ff9900;
            font-weight: bold;
        }

        .volume-extreme {
            color: #ff0000;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        .gamma-zone {
            line-height: 1.4;
            font-size: 11px;
        }

        .gamma-0dte {
            color: #ff00ff;
            font-weight: bold;
            font-size: 11px;
            animation: pulse 2s infinite;
            text-align: center;
            margin-bottom: 4px;
        }

        .gamma-separator {
            color: #333;
            font-size: 8px;
            text-align: center;
            margin: 2px 0;
        }

        .gamma-resistance {
            color: #ff9944;
        }

        .gamma-support {
            color: #44ff44;
        }

        .gamma-strike-price {
            font-weight: bold;
            font-size: 11px;
        }

        .gamma-label {
            font-size: 9px;
            color: #888;
            font-weight: bold;
        }

        .gamma-current {
            text-align: center;
            color: #ffff00;
            font-weight: bold;
            font-size: 11px;
            margin: 2px 0;
        }

        .gamma-data {
            font-size: 10px;
            color: #888;
        }

        .gamma-data.resistance-data {
            color: #ff9944;
        }

        .gamma-data.support-data {
            color: #44ff44;
        }

        .unusual-badge {
            margin-top: 5px;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            line-height: 1.3;
            display: inline-block;
        }

        .unusual-extreme {
            background: #330033;
            color: #ff00ff;
            border: 1px solid #ff00ff;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.5);
            animation: pulse 1s infinite;
        }

        .unusual-high {
            background: #333300;
            color: #ffff00;
            border: 1px solid #ffff00;
        }

        .unusual-moderate {
            background: #003333;
            color: #00ffff;
            border: 1px solid #00ffff;
        }

        .wall-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin: 2px;
        }

        .wall-building {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .wall-weakening {
            background: #330000;
            color: #ff6600;
            border: 1px solid #ff6600;
        }

        .wall-breaking {
            background: #330000;
            color: #ff0000;
            border: 1px solid #ff0000;
            animation: blink 0.8s infinite;
        }

        .refresh-btn {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            border-radius: 3px;
        }

        .refresh-btn:hover {
            background: #00cc00;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #ffff00;
        }

        .error {
            background: #330000;
            color: #ff0000;
            padding: 20px;
            text-align: center;
            border: 1px solid #ff0000;
            margin: 20px;
        }

        .regime-warning {
            background: #330000;
            color: #ff0000;
            padding: 15px;
            text-align: center;
            border: 2px solid #ff0000;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>‚ö° PROFESSIONAL TRADING DASHBOARD v5.0 ‚ö°</h1>
            <div style="font-size: 10px; color: #666; margin-top: 4px;" id="symbolList">
                Loading watchlist...
            </div>
        </div>
        <div style="text-align: right;">
            <div class="market-time" id="marketTime">--:--:-- ET</div>
            <div class="market-status closed" id="marketStatus">MARKET CLOSED</div>
            <div class="controls" style="margin-top: 8px;">
                <span class="watchlist-info" id="watchlistInfo">0 symbols</span>
                <span class="update-indicator" id="updateIndicator">Never</span>
                
                <button class="earnings-toggle" id="earningsToggle" onclick="toggleEarningsMonitoring()">
                    <span id="earningsIcon">üìÖ</span>
                    <span id="earningsText">EARNINGS: ON</span>
                    <span id="earningsCount" style="opacity: 0.7;">(0)</span>
                </button>
                
                <button class="sound-toggle" id="soundToggle">
                    üîá SOUND OFF
                </button>
                <button class="sound-toggle" id="testAlertBtn" style="background: #330033; border-color: #8b5cf6;">
                    üß™ TEST ALERT
                </button>
                <span class="notification-status" id="notificationStatus" onclick="requestNotificationPermission()">
                    NOTIFICATIONS: OFF
                </span>
                
                <button class="refresh-btn" onclick="window.open('gamma_dashboard.html', '_blank')" style="background: #330033; border: 1px solid #ff00ff; color: #ff00ff;">
                    üéØ GAMMA DETAIL
                </button>
                <button class="refresh-btn" onclick="window.open('gex_dashboard.html', '_blank')" style="background: #003300; border: 1px solid #00ff00; color: #00ff00;">
                    üí∞ GEX
                </button>
                <button class="refresh-btn" onclick="window.open('leveraged_dashboard.html', '_blank')" style="background: #331100; border: 1px solid #ff9900; color: #ff9900;">
                    üìä LEVERAGED
                </button>
                <button class="refresh-btn" onclick="window.open('alert_console.html', '_blank')" style="background: #330033; border: 1px solid #ff00ff; color: #ff00ff;">
                    ‚öôÔ∏è ALERTS
                </button>
                <button class="refresh-btn" onclick="window.open('news_dashboard.html', '_blank')" style="background: #003333; border: 1px solid #00ccff; color: #00ccff;">
                    üì∞ NEWS
                </button>
                
                <button class="refresh-btn" id="refreshBtn">REFRESH NOW</button>
            </div>
        </div>
    </div>

    <div id="regimeWarning" style="display: none;" class="regime-warning"></div>

    <!-- Live Greeks Panel -->
    <div class="live-greeks-panel">
        <h2>üî¥ LIVE GREEKS MONITOR (Updates every 10s)</h2>
        <div class="greeks-grid" id="greeksGrid">
            <div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">
                Loading live greeks data...
            </div>
        </div>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>SYMBOL</th>
                    <th>PRICE</th>
                    <th>VWAP üìä</th>
                    <th>% FROM<br>VWAP</th>
                    <th>SUP/RES</th>
                    <th>VOLUME<br>RVOL</th>
                    <th>MOMENTUM<br>üî•</th>
                    <th>DARK POOL üí∞</th>
                    <th style="min-width: 280px;">0DTE GAMMA ZONES üéØ</th>
                    <th>NEWS</th>
                    <th>ENTRY/TP/SL</th>
                    <th>ALERT</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="12" class="loading">LOADING WATCHLIST...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let SYMBOLS = [];
        const API_BASE = 'http://localhost:5001/api';
        
        let soundEnabled = false;
        let notificationsEnabled = false;
        let audioContext = null;
        let previousData = {};
        let previousAlerts = {};
        let isFirstLoad = true;

        let earningsEnabled = true;
        let earningsSymbolsCount = 0;

        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/watchlist`);
                const data = await response.json();
                
                if (data.watchlist && data.watchlist.length > 0) {
                    SYMBOLS = data.watchlist;
                    document.getElementById('watchlistInfo').textContent = `Watchlist: ${SYMBOLS.length} symbols`;
                    document.getElementById('symbolList').textContent = SYMBOLS.join(' | ');
                    console.log(`‚úÖ Loaded ${SYMBOLS.length} symbols from watchlist:`, SYMBOLS);
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è No symbols in watchlist, using defaults');
                    SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                    document.getElementById('symbolList').textContent = SYMBOLS.join(' | ') + ' (DEFAULT)';
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error loading watchlist:', error);
                SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                document.getElementById('symbolList').textContent = SYMBOLS.join(' | ') + ' (DEFAULT - ERROR)';
                return false;
            }
        }

        async function loadEarningsStatus() {
            try {
                const response = await fetch(`${API_BASE}/earnings/status`);
                const data = await response.json();
                
                earningsEnabled = data.enabled;
                earningsSymbolsCount = data.symbols_count;
                
                updateEarningsDisplay();
                
                console.log(`üìÖ Earnings monitoring: ${earningsEnabled ? 'ENABLED' : 'DISABLED'} (${earningsSymbolsCount} symbols)`);
            } catch (error) {
                console.error('Error loading earnings status:', error);
            }
        }

        function updateEarningsDisplay() {
            const btn = document.getElementById('earningsToggle');
            if (earningsEnabled && earningsSymbolsCount > 0) {
                btn.textContent = `üìÖ EARNINGS (${earningsSymbolsCount})`;
                btn.classList.remove('disabled');
            } else {
                btn.textContent = `üìÖ EARNINGS (OFF)`;
                btn.classList.add('disabled');
            }
        }

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAlertSound(alertType) {
            if (!soundEnabled || !audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (alertType.includes('EXTREME') || alertType.includes('WAIT')) {
                // Urgent triple beep
                [0, 0.15, 0.3].forEach((delay, i) => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.setValueAtTime(1200, audioContext.currentTime + delay);
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime + delay);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + delay + 0.1);
                    osc.start(audioContext.currentTime + delay);
                    osc.stop(audioContext.currentTime + delay + 0.1);
                });
            } else if (alertType.includes('STRONG')) {
                // Double beep for STRONG signals
                [0, 0.15].forEach(delay => {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.setValueAtTime(1000, audioContext.currentTime + delay);
                    gain.gain.setValueAtTime(0.3, audioContext.currentTime + delay);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + delay + 0.15);
                    osc.start(audioContext.currentTime + delay);
                    osc.stop(audioContext.currentTime + delay + 0.15);
                });
            } else if (alertType.includes('SHIFT') || alertType.includes('PROFIT')) {
                // Descending tone for momentum shift
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(500, audioContext.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            } else {
                // Single beep for regular signals
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.15);
            }
        }

        function showNotification(symbol, alertType, confidence) {
            if (!notificationsEnabled) return;

            if ('Notification' in window && Notification.permission === 'granted') {
                const confidenceText = confidence ? ` (${confidence.toFixed(0)}%)` : '';
                const emoji = alertType.includes('BUY') ? 'üü¢' : alertType.includes('SELL') ? 'üî¥' : 'üü°';
                
                const notification = new Notification(`${emoji} ${symbol} - ${alertType}`, {
                    body: `Confidence: ${confidenceText}`,
                    icon: '/static/icon.png',
                    badge: '/static/badge.png',
                    vibrate: [200, 100, 200],
                    tag: symbol
                });

                notification.onclick = function() {
                    window.focus();
                    this.close();
                };

                setTimeout(() => notification.close(), 10000);
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                updateNotificationStatus();
                return permission === 'granted';
            }
            return Notification.permission === 'granted';
        }

        function updateNotificationStatus() {
            const statusEl = document.getElementById('notificationStatus');
            if ('Notification' in window && Notification.permission === 'granted') {
                notificationsEnabled = true;
                statusEl.textContent = 'NOTIFICATIONS: ON';
                statusEl.classList.add('enabled');
            } else {
                notificationsEnabled = false;
                statusEl.textContent = 'NOTIFICATIONS: OFF';
                statusEl.classList.remove('enabled');
            }
        }

        document.getElementById('soundToggle').addEventListener('click', function() {
            initAudio();
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? 'üîä SOUND ON' : 'üîá SOUND OFF';
            this.classList.toggle('active', soundEnabled);
        });

        document.getElementById('testAlertBtn').addEventListener('click', function() {
            initAudio();
            playAlertSound('STRONG BUY');
            showNotification('TEST', 'STRONG BUY', 95);
        });

        document.getElementById('refreshBtn').addEventListener('click', loadData);

        function updateTime() {
            const now = new Date();
            const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const timeStr = et.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('marketTime').textContent = timeStr + ' ET';

            const day = et.getDay();
            const hour = et.getHours();
            const minute = et.getMinutes();
            const currentMinutes = hour * 60 + minute;

            const isWeekday = day >= 1 && day <= 5;
            const marketOpen = 9 * 60 + 30;
            const marketClose = 16 * 60;

            const isOpen = isWeekday && currentMinutes >= marketOpen && currentMinutes < marketClose;

            const statusEl = document.getElementById('marketStatus');
            if (isOpen) {
                statusEl.textContent = 'MARKET OPEN';
                statusEl.className = 'market-status open';
            } else if (isWeekday && currentMinutes >= 4 * 60 && currentMinutes < marketOpen) {
                statusEl.textContent = 'PRE-MARKET';
                statusEl.className = 'market-status open';
            } else {
                statusEl.textContent = 'MARKET CLOSED';
                statusEl.className = 'market-status closed';
            }
        }

        function formatPrice(price) {
            return price > 0 ? `${price.toFixed(2)}` : '--';
        }

        function getVolumeClass(classification) {
            const lowerClass = (classification || 'unknown').toLowerCase();
            return `volume-${lowerClass}`;
        }

        function formatVolumeDisplay(volumeData) {
            // UPDATED: Combines pre-market and intraday into one display
            if (!volumeData) {
                return '<span class="volume-unknown">--</span>';
            }
            
            const rvol = volumeData.rvol || 0;
            
            if (rvol === 0) {
                return '<span class="volume-unknown">--</span>';
            }
            
            const classification = volumeData.classification || 'UNKNOWN';
            const direction = volumeData.direction || '';
            const spikeDetected = volumeData.spike_detected || false;
            const cssClass = getVolumeClass(classification);
            
            const spikeEmoji = spikeDetected ? ' üî•' : '';
            
            let display = `<span class="${cssClass}">${rvol.toFixed(2)}x${spikeEmoji}<br><small>${classification}</small></span>`;
            
            if (direction && direction !== 'NEUTRAL' && direction !== 'UNKNOWN') {
                const dirEmoji = direction === 'BREAKOUT' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                display += `<br><span style="font-size: 9px;">${dirEmoji} ${direction}</span>`;
            }
            
            return display;
        }

        // NEW: Format VWAP distance
        function formatVWAPDistance(current_price, vwap) {
            if (!current_price || !vwap || vwap === 0) {
                return '<span class="vwap-neutral">--</span>';
            }
            
            const distance_pct = ((current_price - vwap) / vwap) * 100;
            
            let cssClass = 'vwap-neutral';
            if (Math.abs(distance_pct) < 0.1) {
                cssClass = 'vwap-neutral';
            } else if (distance_pct > 0) {
                cssClass = 'vwap-above'; // Above VWAP = extended upside
            } else {
                cssClass = 'vwap-below'; // Below VWAP = extended downside
            }
            
            const sign = distance_pct > 0 ? '+' : '';
            
            return `<span class="vwap-distance ${cssClass}">${sign}${distance_pct.toFixed(2)}%</span>`;
        }

        // NEW: Format momentum arrows
        function formatMomentum(momentum) {
            if (!momentum) {
                return '<span class="momentum-neutral">‚Üí ‚Üí ‚Üí</span>';
            }
            
            const m1 = momentum['1m'] || 'NEUTRAL';
            const m5 = momentum['5m'] || 'NEUTRAL';
            const m15 = momentum['15m'] || 'NEUTRAL';
            
            function getArrow(trend) {
                if (trend === 'BULLISH') return '<span class="momentum-bullish">‚Üë</span>';
                if (trend === 'BEARISH') return '<span class="momentum-bearish">‚Üì</span>';
                return '<span class="momentum-neutral">‚Üí</span>';
            }
            
            return `<div class="momentum-cell">${getArrow(m1)} ${getArrow(m5)} ${getArrow(m15)}</div>`;
        }

        function getWallStrengthBadge(wallStrength, strike, type) {
            if (!wallStrength || !wallStrength.available) {
                return '';
            }
            
            const changes = wallStrength.walls || [];
            
            const change = changes.find(c => Math.abs(c.strike - strike) < 0.01 && c.type === type);
            
            if (!change) {
                return '';
            }
            
            const changePct = change.change_pct;
            
            if (change.pattern === 'BUILDING') {
                if (changePct >= 50) {
                    return '<span class="wall-badge wall-building">üî•üî• +' + changePct.toFixed(0) + '%</span>';
                } else if (changePct >= 25) {
                    return '<span class="wall-badge wall-building">üî• +' + changePct.toFixed(0) + '%</span>';
                }
            } else if (change.pattern === 'WEAKENING') {
                if (changePct <= -40) {
                    return '<span class="wall-badge wall-breaking">üö® ' + changePct.toFixed(0) + '%</span>';
                } else if (changePct <= -25) {
                    return '<span class="wall-badge wall-weakening">‚ö†Ô∏è‚ö†Ô∏è ' + changePct.toFixed(0) + '%</span>';
                } else if (changePct <= -15) {
                    return '<span class="wall-badge wall-weakening">‚ö†Ô∏è ' + changePct.toFixed(0) + '%</span>';
                }
            }
            
            return '';
        }

        function formatUnusualActivity(unusualData) {
            if (!unusualData || !unusualData.detected) {
                return '';
            }
            
            const alerts = unusualData.alerts || [];
            if (alerts.length === 0) {
                return '';
            }
            
            const topAlert = alerts[0];
            
            let badgeClass = 'unusual-moderate';
            if (topAlert.urgency === 'EXTREME') {
                badgeClass = 'unusual-extreme';
            } else if (topAlert.urgency === 'HIGH') {
                badgeClass = 'unusual-high';
            }
            
            const strike = topAlert.strike;
            const optionType = topAlert.option_type[0];
            const oiChange = topAlert.oi_change_pct;
            
            return `<div class="unusual-badge ${badgeClass}">üî• UNUSUAL<br>${strike}${optionType} ${oiChange > 0 ? '+' : ''}${oiChange.toFixed(0)}% OI</div>`;
        }

        function formatGammaZones(openInterest, wallStrength) {
            if (!openInterest || !openInterest.available) {
                return '<span class="volume-unknown">No data</span>';
            }
            
            const gammaLevels = openInterest.gamma_levels || [];
            const currentPrice = openInterest.current_price || 0;
            const expiresToday = openInterest.expires_today || false;
            const hoursUntil = openInterest.hours_until_expiry || 0;
            const dataSource = openInterest.data_source || 'unknown';
            
            if (gammaLevels.length === 0) {
                return '<span class="volume-unknown">No walls detected</span>';
            }
            
            let html = '<div class="gamma-zone">';
            
            if (expiresToday && hoursUntil > 0) {
                html += `<div class="gamma-0dte">‚è∞ 0DTE - ${hoursUntil.toFixed(1)}h LEFT</div>`;
            } else if (expiresToday) {
                html += `<div class="gamma-0dte">üî¥ EXPIRED</div>`;
            } else {
                const expDate = openInterest.expiration || '';
                html += `<div style="color:#888;font-size:10px;font-weight:bold;">Exp: ${expDate}</div>`;
            }
            
            html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
            
            const sortedLevels = [...gammaLevels].sort((a, b) => b.strike - a.strike);
            
            const resistance = sortedLevels.filter(l => l.strike > currentPrice).slice(0, 2);
            const support = sortedLevels.filter(l => l.strike <= currentPrice).slice(0, 2);
            
            for (const level of resistance) {
                const oiK = (level.total_oi / 1000).toFixed(0);
                const volK = (level.total_volume / 1000).toFixed(0);
                const emoji = level.strength === 'STRONG' ? 'üî¥' : level.strength === 'MODERATE' ? 'üü†' : '‚ö™';
                
                html += `<div class="gamma-resistance" style="margin: 4px 0;">`;
                html += `<span class="gamma-strike-price">${emoji} $${level.strike}</span> `;
                html += `<span class="gamma-label">RESIST</span>`;
                
                html += getWallStrengthBadge(wallStrength, level.strike, 'RESISTANCE');
                
                html += `<br><span class="gamma-data resistance-data">OI: ${oiK}K | Vol: ${volK}K</span>`;
                html += `<br><span style="font-size:9px;color:#777;">${level.direction} ${Math.abs(level.distance_pct).toFixed(1)}%</span>`;
                html += `</div>`;
            }
            
            html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
            html += `<div class="gamma-current">üìç NOW: $${currentPrice.toFixed(2)}</div>`;
            html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
            
            for (const level of support) {
                const oiK = (level.total_oi / 1000).toFixed(0);
                const volK = (level.total_volume / 1000).toFixed(0);
                const emoji = level.strength === 'STRONG' ? 'üü¢' : level.strength === 'MODERATE' ? 'üü°' : '‚ö™';
                
                html += `<div class="gamma-support" style="margin: 4px 0;">`;
                html += `<span class="gamma-strike-price">${emoji} $${level.strike}</span> `;
                html += `<span class="gamma-label">SUPPORT</span>`;
                
                html += getWallStrengthBadge(wallStrength, level.strike, 'SUPPORT');
                
                html += `<br><span class="gamma-data support-data">OI: ${oiK}K | Vol: ${volK}K</span>`;
                html += `<br><span style="font-size:9px;color:#777;">${level.direction} ${Math.abs(level.distance_pct).toFixed(1)}%</span>`;
                html += `</div>`;
            }
            
            if (openInterest.expected_range) {
                const range = openInterest.expected_range;
                html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
                html += `<div style="font-size:10px;color:#999;font-weight:bold;">Range: $${range.low.toFixed(0)}-$${range.high.toFixed(0)}</div>`;
            }
            
            if (dataSource === 'tradier') {
                html += `<div style="font-size:8px;color:#666;margin-top:3px;">üì° Tradier Live</div>`;
            } else if (dataSource === 'polygon_fallback') {
                html += `<div style="font-size:8px;color:#ff6600;margin-top:3px;">‚ö†Ô∏è Fallback Data</div>`;
            }
            
            html += '</div>';
            
            return html;
        }

        function formatDarkPool(darkPoolData) {
            if (!darkPoolData || !darkPoolData.institutional_flow) {
                return '<span class="institutional-neutral">--</span>';
            }
            
            const flow = darkPoolData.institutional_flow;
            const activity = darkPoolData.activity || 'LIGHT';
            const blockValue = darkPoolData.block_trade_value || 0;
            const signalStrength = darkPoolData.signal_strength || 0;
            
            let display = `<span class="institutional-${flow.toLowerCase()}">${flow}</span>`;
            
            if (activity !== 'LIGHT') {
                display += `<br><span style="font-size:9px;color:#666;">${activity}</span>`;
            }
            
            if (blockValue > 10000) {
                const valueMil = (blockValue / 1000000).toFixed(1);
                display += `<br><span style="font-size:9px;color:#ffff00;">$${valueMil}M</span>`;
            }
            
            if (signalStrength > 0) {
                const bars = '‚ñà'.repeat(Math.min(signalStrength, 5));
                display += `<br><span style="font-size:9px;color:#00ff00;">${bars}</span>`;
            }
            
            return display;
        }

        function getAlertClass(alertType) {
            if (!alertType || alertType === 'MONITOR') return 'alert-monitor';
            if (alertType.includes('EXTREME') || alertType.includes('WAIT')) return 'alert-extreme';
            if (alertType.includes('BUY')) return 'alert-buy';
            if (alertType.includes('SELL')) return 'alert-sell';
            if (alertType.includes('SHIFT') || alertType.includes('PROFIT')) return 'alert-tp';
            return 'alert-monitor';
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 75) return 'high';
            if (confidence >= 60) return 'medium';
            return 'low';
        }

        function updateCell(cell, newContent, animated = true) {
            if (cell.innerHTML !== newContent) {
                cell.innerHTML = newContent;
                if (animated && !isFirstLoad) {
                    cell.classList.add('value-changed');
                    setTimeout(() => cell.classList.remove('value-changed'), 500);
                }
            }
        }

        function updateRow(symbol, data) {
            let row = document.querySelector(`tr[data-symbol="${symbol}"]`);
            
            if (!row) {
                const tbody = document.getElementById('tableBody');
                if (tbody.children[0]?.colSpan === 12) {
                    tbody.innerHTML = '';
                }
                row = document.createElement('tr');
                row.setAttribute('data-symbol', symbol);
                row.innerHTML = '<td></td>'.repeat(12); // UPDATED: 12 columns now
                tbody.appendChild(row);
            }

            const cells = row.children;
            const entryTargets = data.entry_targets || {};
            const volumeData = data.volume_analysis?.volume_spike || data.premarket_rvol || {};
            
            // NEW COLUMN ORDER:
            // 0: Symbol
            // 1: Price
            // 2: VWAP (NEW)
            // 3: % FROM VWAP (NEW)
            // 4: Sup/Res
            // 5: Volume (COMBINED)
            // 6: Momentum (NEW)
            // 7: Dark Pool
            // 8: Gamma Zones
            // 9: News
            // 10: Entry/TP/SL
            // 11: Alert
            
            updateCell(cells[0], `<span class="symbol">${data.symbol}</span>`, false);
            updateCell(cells[1], `<span class="price">${formatPrice(data.current_price)}</span>`);
            updateCell(cells[2], `<span class="vwap-price">${formatPrice(data.vwap)}</span>`); // NEW
            updateCell(cells[3], formatVWAPDistance(data.current_price, data.vwap)); // NEW
            updateCell(cells[4], `<span class="level" style="line-height: 1.4;">RES: ${formatPrice(data.resistance)}<br>SUP: ${formatPrice(data.support)}</span>`);
            updateCell(cells[5], formatVolumeDisplay(volumeData)); // COMBINED
            updateCell(cells[6], formatMomentum(data.momentum)); // NEW
            updateCell(cells[7], formatDarkPool(data.dark_pool_details || {}));
            
            // Gamma zones + Unusual Activity
            let gammaContent = formatGammaZones(data.open_interest || {}, data.wall_strength || {});
            const unusualContent = formatUnusualActivity(data.unusual_activity || {});
            if (unusualContent) {
                gammaContent += unusualContent;
            }
            updateCell(cells[8], gammaContent);
            updateCell(cells[9], `<span class="news-${(data.news_sentiment || 'neutral').toLowerCase().replace(/\s+/g, '.')}">${data.news_sentiment || '--'}</span>`);
            
            const entryInfo = entryTargets.entry ? 
                `E: ${formatPrice(entryTargets.entry)}<br>TP: ${formatPrice(entryTargets.tp1)}<br>SL: ${formatPrice(entryTargets.stop_loss)}` : '--';
            updateCell(cells[10], `<span class="entry-targets" style="line-height: 1.4;">${entryInfo}</span>`);

            const alertClass = getAlertClass(data.alert_type);
            const currentAlert = data.alert_type || 'MONITOR';
            const previousAlert = previousAlerts[symbol] || 'MONITOR';
            const isNewAlert = currentAlert !== previousAlert && currentAlert !== 'MONITOR';
            
            const alertContent = `<span class="${alertClass}">${data.alert_type || 'MONITOR'}${data.confidence ? `<br><span class="confidence ${getConfidenceClass(data.confidence)}">${data.confidence.toFixed(0)}%</span>` : ''}</span>`;
            
            if (cells[11].innerHTML !== alertContent) {
                cells[11].innerHTML = alertContent;
                
                if (isNewAlert && !isFirstLoad) {
                    cells[11].classList.add('alert-changed');
                    setTimeout(() => cells[11].classList.remove('alert-changed'), 2000);
                    
                    playAlertSound(currentAlert);
                    showNotification(data.symbol, currentAlert, data.confidence);
                }
            }
            
            previousAlerts[symbol] = currentAlert;
        }

        async function loadData() {
            if (SYMBOLS.length === 0) {
                console.log('‚è≥ Waiting for watchlist to load...');
                return;
            }

            const indicator = document.getElementById('updateIndicator');
            indicator.textContent = 'Updating...';
            indicator.classList.add('updating');

            try {
                const promises = SYMBOLS.map(symbol => 
                    fetch(`${API_BASE}/analyze/${symbol}`)
                        .then(r => r.json())
                        .catch(e => ({ symbol, error: e.message }))
                );

                const results = await Promise.all(promises);
                
                let extremeRegimeDetected = false;
                let regimeMessage = '';
                
                for (const data of results) {
                    if (data.market_regime === 'EXTREME_BEARISH') {
                        extremeRegimeDetected = true;
                        regimeMessage = 'üö® EXTREME BEARISH REGIME DETECTED - MARKET CRASH MODE - NO BUY SIGNALS';
                        break;
                    } else if (data.market_regime === 'EXTREME_BULLISH') {
                        extremeRegimeDetected = true;
                        regimeMessage = 'üö® EXTREME BULLISH REGIME DETECTED - EUPHORIA MODE - NO SELL SIGNALS';
                        break;
                    }
                }
                
                const regimeWarning = document.getElementById('regimeWarning');
                if (extremeRegimeDetected) {
                    regimeWarning.textContent = regimeMessage;
                    regimeWarning.style.display = 'block';
                } else {
                    regimeWarning.style.display = 'none';
                }

                results.forEach(data => {
                    if (!data.error) {
                        updateRow(data.symbol, data);
                    }
                });

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                indicator.textContent = `Updated: ${timeStr}`;
                indicator.classList.remove('updating');
                
                isFirstLoad = false;

            } catch (error) {
                indicator.textContent = 'Update failed';
                indicator.classList.remove('updating');
                console.error('Error loading data:', error);
            }
        }

        async function initialize() {
            console.log('üöÄ Initializing Professional Trading Dashboard v5.0 - OPTIMIZED FOR DAY TRADING');
            
            await loadWatchlist();
            
            // Start live greeks updates after SYMBOLS loaded
            if (SYMBOLS && SYMBOLS.length > 0) {
                console.log('üî¥ Starting Live Greeks Monitor...');
                updateLiveGreeks(); // Initial load
                setInterval(updateLiveGreeks, 10000); // Every 10 seconds
            }
            
            await loadEarningsStatus();
            
            setInterval(updateTime, 1000);
            updateTime();
            updateNotificationStatus();

            await loadData();
            
            setInterval(loadData, 30000);
            setInterval(loadEarningsStatus, 60000);

            setTimeout(() => {
                if ('Notification' in window && Notification.permission === 'default') {
                    requestNotificationPermission();
                }
            }, 2000);
            
            console.log('‚úÖ Dashboard initialized with', SYMBOLS.length, 'symbols');
            console.log(`üìÖ Earnings monitoring: ${earningsEnabled ? 'ENABLED' : 'DISABLED'} (${earningsSymbolsCount} symbols)`);
            console.log('üìä NEW: VWAP and Momentum columns added');
            console.log('üî• OPTIMIZED: Combined volume column for cleaner view');
            console.log('üéØ 0DTE gamma pinning detection active');
            console.log('üß± Wall strength tracking enabled');
        }

        // ==================== LIVE GREEKS MONITOR ====================
        let previousDeltas = {}; // Track delta changes

        async function updateLiveGreeks() {
            try {
                const response = await fetch(`${API_BASE}/live-greeks/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ symbols: SYMBOLS })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displayLiveGreeks(data);
                
            } catch (error) {
                console.error('Error updating live greeks:', error);
                document.getElementById('greeksGrid').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #ff0000; padding: 20px;">
                        ‚ö†Ô∏è Error loading live greeks: ${error.message}
                    </div>
                `;
            }
        }

        function displayLiveGreeks(data) {
            const grid = document.getElementById('greeksGrid');
            
            if (!data || Object.keys(data).length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">
                        No live greeks data available
                    </div>
                `;
                return;
            }
            
            // Filter for relevant tickers (near walls or big moves)
            const relevantTickers = Object.entries(data).filter(([symbol, greeks]) => {
                // Show if near gamma wall (<3%)
                if (greeks.wall_distance_pct && greeks.wall_distance_pct < 3.0) {
                    return true;
                }
                
                // Show if delta changed significantly
                if (previousDeltas[symbol]) {
                    const deltaChange = Math.abs(greeks.delta - previousDeltas[symbol]);
                    if (deltaChange >= 0.05) {
                        return true;
                    }
                }
                
                // Always show first few tickers
                return Object.keys(previousDeltas).length < 5;
            });
            
            if (relevantTickers.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #888; padding: 20px;">
                        üìä No significant greek movements detected<br>
                        <span style="font-size: 10px; color: #666;">Monitoring ${Object.keys(data).length} symbols...</span>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = relevantTickers.map(([symbol, greeks]) => {
                const prevDelta = previousDeltas[symbol] || greeks.delta;
                const deltaChange = greeks.delta - prevDelta;
                const deltaChangeAbs = Math.abs(deltaChange);
                
                let deltaChangeClass = 'delta-neutral';
                let deltaArrow = '‚Üí';
                if (deltaChange > 0.01) {
                    deltaChangeClass = 'delta-up';
                    deltaArrow = '‚¨ÜÔ∏è';
                } else if (deltaChange < -0.01) {
                    deltaChangeClass = 'delta-down';
                    deltaArrow = '‚¨áÔ∏è';
                }
                
                // Store current delta
                previousDeltas[symbol] = greeks.delta;
                
                // Check if near wall
                const nearWall = greeks.wall_distance_pct && greeks.wall_distance_pct < 3.0;
                const wallAlert = nearWall ? `
                    <div class="wall-alert">
                        üî• ${greeks.wall_distance_pct.toFixed(1)}% FROM ${greeks.wall_type} WALL
                    </div>
                ` : '';
                
                return `
                    <div class="greek-card">
                        <div class="symbol">${symbol}</div>
                        <div class="price">$${greeks.price.toFixed(2)}</div>
                        
                        <div class="greek-stats">
                            <div class="greek-stat">
                                <div class="greek-stat-label">Delta</div>
                                <div class="greek-stat-value">${greeks.delta.toFixed(2)}</div>
                                <div class="delta-change ${deltaChangeClass}">
                                    ${prevDelta.toFixed(2)} ${deltaArrow} ${greeks.delta.toFixed(2)}
                                </div>
                            </div>
                            
                            <div class="greek-stat">
                                <div class="greek-stat-label">Gamma</div>
                                <div class="greek-stat-value">${greeks.gamma.toFixed(3)}</div>
                            </div>
                            
                            <div class="greek-stat">
                                <div class="greek-stat-label">Wall</div>
                                <div class="greek-stat-value" style="font-size: 12px;">
                                    ${greeks.wall_strike ? '$' + greeks.wall_strike.toFixed(2) : '--'}
                                </div>
                                <div style="font-size: 9px; color: #888;">
                                    ${greeks.wall_distance_pct ? greeks.wall_distance_pct.toFixed(1) + '%' : '--'}
                                </div>
                            </div>
                        </div>
                        
                        ${wallAlert}
                    </div>
                `;
            }).join('');
        }

        // ==================== END LIVE GREEKS MONITOR ====================

        initialize();
    </script>
</body>
</html>