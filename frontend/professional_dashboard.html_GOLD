<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Trading Dashboard v4.2 - TRADIER GAMMA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            background: #000000;
            color: #00ff00;
            padding: 10px;
            font-size: 12px;
        }

        .header {
            background: #0a0a0a;
            padding: 15px;
            border: 1px solid #00ff00;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            color: #00ff00;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sound-toggle, .earnings-toggle {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            border-radius: 3px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .sound-toggle:hover, .earnings-toggle:hover {
            background: #004400;
        }

        .sound-toggle.active {
            background: #00ff00;
            color: #000;
        }

        .earnings-toggle {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .earnings-toggle.disabled {
            background: #332200;
            color: #ff6600;
            border-color: #ff6600;
        }

        .notification-status {
            font-size: 10px;
            color: #ffff00;
            padding: 4px 8px;
            border: 1px solid #ffff00;
            border-radius: 3px;
            cursor: pointer;
        }

        .notification-status.enabled {
            color: #00ff00;
            border-color: #00ff00;
        }

        .market-time {
            font-size: 14px;
            color: #ffff00;
        }

        .market-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: bold;
        }

        .market-status.open {
            background: #00ff00;
            color: #000;
        }

        .market-status.closed {
            background: #ff0000;
            color: #fff;
        }

        .update-indicator {
            font-size: 10px;
            color: #666;
            padding: 4px 8px;
            border-radius: 3px;
        }

        .update-indicator.updating {
            color: #ffff00;
            animation: pulse 1s infinite;
        }

        .watchlist-info {
            font-size: 10px;
            color: #00ccff;
            padding: 4px 8px;
            border: 1px solid #00ccff;
            border-radius: 3px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #00ff00;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #0a0a0a;
        }

        th {
            background: #001a00;
            color: #00ff00;
            padding: 8px 6px;
            text-align: left;
            font-size: 10px;
            text-transform: uppercase;
            border: 1px solid #00ff00;
            white-space: nowrap;
        }

        td {
            padding: 6px;
            border: 1px solid #003300;
            font-size: 11px;
            white-space: nowrap;
            transition: background-color 0.3s ease;
        }

        tr:hover {
            background: #001a00;
        }

        .value-changed {
            animation: flashValue 0.5s ease-in-out;
        }

        @keyframes flashValue {
            0%, 100% { background-color: transparent; }
            50% { background-color: #1a3300; }
        }

        .alert-changed {
            animation: flashAlert 1s ease-in-out 2;
        }

        @keyframes flashAlert {
            0%, 100% { 
                box-shadow: 0 0 0px rgba(255, 255, 0, 0);
            }
            50% { 
                box-shadow: 0 0 15px rgba(255, 255, 0, 0.8);
            }
        }

        .symbol {
            font-weight: bold;
            font-size: 14px;
            color: #ffffff;
        }

        .price {
            font-weight: bold;
            color: #ffff00;
        }

        .bullish {
            color: #00ff00;
            font-weight: bold;
        }

        .bearish {
            color: #ff0000;
            font-weight: bold;
        }

        .neutral {
            color: #888888;
        }

        .volume-extreme {
            color: #ff0000;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        .volume-high {
            color: #ff6600;
            font-weight: bold;
        }

        .volume-elevated {
            color: #ffff00;
            font-weight: bold;
        }

        .volume-normal {
            color: #00ff00;
        }

        .volume-low {
            color: #888888;
        }

        .volume-unknown {
            color: #666666;
        }

        .alert-buy {
            background: #003300;
            color: #00ff00;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
        }

        .alert-sell {
            background: #330000;
            color: #ff0000;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
        }

        .alert-tp {
            background: #333300;
            color: #ffff00;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
            animation: blink 1s infinite;
        }

        .alert-extreme {
            background: #330033;
            color: #ff00ff;
            padding: 4px 8px;
            border-radius: 3px;
            font-weight: bold;
            text-align: center;
            animation: blink 0.5s infinite;
        }

        .alert-monitor {
            color: #666666;
            padding: 4px 8px;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        .level {
            font-family: monospace;
            color: #00ccff;
        }

        .news-positive, .news-very.positive {
            color: #00ff00;
        }

        .news-negative, .news-very.negative {
            color: #ff0000;
        }

        .news-neutral {
            color: #888888;
        }

        .institutional-buy, .institutional-buying {
            color: #00ff00;
            font-weight: bold;
        }

        .institutional-sell, .institutional-selling {
            color: #ff0000;
            font-weight: bold;
        }

        .institutional-neutral, .institutional-mixed {
            color: #888888;
        }

        .confidence {
            font-weight: bold;
        }

        .confidence.high {
            color: #00ff00;
        }

        .confidence.medium {
            color: #ffff00;
        }

        .confidence.low {
            color: #ff6600;
        }

        .entry-targets {
            font-size: 10px;
            color: #00ccff;
            line-height: 1.4;
        }

        /* ENHANCED: Gamma zones styling - MUCH MORE READABLE */
        .gamma-zone {
            font-size: 11px;
            line-height: 1.5;
        }

        .gamma-strike-price {
            font-size: 13px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        .gamma-label {
            font-size: 11px;
            font-weight: bold;
            letter-spacing: 0.3px;
        }

        .gamma-resistance {
            color: #ff8800;
            font-weight: bold;
        }

        .gamma-resistance .gamma-strike-price {
            color: #ff6600;
        }

        .gamma-support {
            color: #00ff00;
            font-weight: bold;
        }

        .gamma-support .gamma-strike-price {
            color: #00ff00;
        }

        .gamma-current {
            color: #ffff00;
            font-weight: bold;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        .gamma-0dte {
            color: #ff00ff;
            font-weight: bold;
            font-size: 12px;
            animation: blink 1.5s infinite;
        }

        .gamma-separator {
            color: #333;
            margin: 3px 0;
            font-size: 8px;
        }

        .gamma-data {
            font-size: 10px;
            color: #888;
        }

        .gamma-data.resistance-data {
            color: #ff9944;
        }

        .gamma-data.support-data {
            color: #44ff44;
        }

        .refresh-btn {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            border-radius: 3px;
        }

        .refresh-btn:hover {
            background: #00cc00;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 14px;
            color: #ffff00;
        }

        .error {
            background: #330000;
            color: #ff0000;
            padding: 20px;
            text-align: center;
            border: 1px solid #ff0000;
            margin: 20px;
        }

        .regime-warning {
            background: #330033;
            border: 2px solid #ff00ff;
            padding: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            color: #ff00ff;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>‚ö° PROFESSIONAL TRADING DASHBOARD v4.2 - ENHANCED GAMMA ‚ö°</h1>
            <div style="font-size: 10px; color: #666; margin-top: 4px;" id="symbolList">
                Loading watchlist...
            </div>
        </div>
        <div style="text-align: right;">
            <div class="market-time" id="marketTime">--:--:-- ET</div>
            <div class="market-status closed" id="marketStatus">MARKET CLOSED</div>
            <div class="controls" style="margin-top: 8px;">
                <span class="watchlist-info" id="watchlistInfo">Watchlist: --</span>
                <span class="update-indicator" id="updateIndicator">Updated: --:--</span>
                
                <button class="earnings-toggle" id="earningsToggle" onclick="toggleEarningsMonitoring()">
                    <span id="earningsIcon">üìÖ</span>
                    <span id="earningsText">EARNINGS: ON</span>
                    <span id="earningsCount" style="opacity: 0.7;">(0)</span>
                </button>
                
                <button class="sound-toggle" id="soundToggle">
                    üîá SOUND OFF
                </button>
                <button class="sound-toggle" id="testAlertBtn" style="background: #330033; border-color: #8b5cf6;">
                    üß™ TEST ALERT
                </button>
                <span class="notification-status" id="notificationStatus" onclick="requestNotificationPermission()">NOTIFICATIONS: OFF</span>
                <button class="refresh-btn" onclick="window.open('gamma_dashboard.html', '_blank')" style="background: #330033; border: 1px solid #ff00ff; color: #ff00ff;">
                    üéØ GAMMA DETAIL VIEW
                </button>
                <button class="refresh-btn" onclick="window.location.href='leveraged_dashboard.html'" style="background: #003366; border: 1px solid #00ccff; color: #00ccff;">
                    üìä LEVERAGED CALC
                </button>
                <button class="refresh-btn" id="refreshBtn">REFRESH NOW</button>
            </div>
        </div>
    </div>

    <div id="regimeWarning" style="display: none;" class="regime-warning"></div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>SYMBOL</th>
                    <th>PRICE</th>
                    <th>VWAP</th>
                    <th>CAMARILLA</th>
                    <th>SUP/RES</th>
                    <th>PRE-MKT RVOL</th>
                    <th>INTRADAY SPIKE</th>
                    <th>DARK POOL üí∞</th>
                    <th style="min-width: 280px;">0DTE GAMMA ZONES üéØ</th>
                    <th>NEWS</th>
                    <th>ENTRY/TP/SL</th>
                    <th>ALERT</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="12" class="loading">LOADING WATCHLIST...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        let SYMBOLS = [];
        const API_BASE = 'http://localhost:5001/api';
        
        let soundEnabled = false;
        let notificationsEnabled = false;
        let audioContext = null;
        let previousData = {};
        let previousAlerts = {};
        let isFirstLoad = true;

        let earningsEnabled = true;
        let earningsSymbolsCount = 0;

        async function loadWatchlist() {
            try {
                const response = await fetch(`${API_BASE}/watchlist`);
                const data = await response.json();
                
                if (data.symbols && data.symbols.length > 0) {
                    SYMBOLS = data.symbols;
                    document.getElementById('watchlistInfo').textContent = `Watchlist: ${SYMBOLS.length} symbols`;
                    document.getElementById('symbolList').textContent = SYMBOLS.join(' | ');
                    console.log(`‚úÖ Loaded ${SYMBOLS.length} symbols from watchlist:`, SYMBOLS);
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è No symbols in watchlist, using defaults');
                    SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                    document.getElementById('symbolList').textContent = SYMBOLS.join(' | ') + ' (DEFAULT)';
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error loading watchlist:', error);
                SYMBOLS = ['SPY', 'QQQ', 'NVDA', 'TSLA', 'AAPL', 'PLTR', 'ORCL'];
                document.getElementById('symbolList').textContent = SYMBOLS.join(' | ') + ' (DEFAULT - ERROR)';
                return false;
            }
        }

        async function loadEarningsStatus() {
            try {
                const response = await fetch(`${API_BASE}/earnings/status`);
                const data = await response.json();
                
                earningsEnabled = data.enabled;
                earningsSymbolsCount = data.symbols_count;
                
                updateEarningsDisplay();
                
                console.log(`üìÖ Earnings monitoring: ${earningsEnabled ? 'ENABLED' : 'DISABLED'} (${earningsSymbolsCount} symbols)`);
            } catch (error) {
                console.error('Error loading earnings status:', error);
            }
        }

        function updateEarningsDisplay() {
            const toggleBtn = document.getElementById('earningsToggle');
            const iconEl = document.getElementById('earningsIcon');
            const textEl = document.getElementById('earningsText');
            const countEl = document.getElementById('earningsCount');
            
            if (earningsEnabled) {
                toggleBtn.classList.remove('disabled');
                iconEl.textContent = 'üìÖ';
                textEl.textContent = 'EARNINGS: ON';
                countEl.textContent = `(${earningsSymbolsCount})`;
            } else {
                toggleBtn.classList.add('disabled');
                iconEl.textContent = 'üö´';
                textEl.textContent = 'EARNINGS: OFF';
                countEl.textContent = '(DISABLED)';
            }
        }

        async function toggleEarningsMonitoring() {
            try {
                const endpoint = earningsEnabled ? 'disable' : 'enable';
                const response = await fetch(`${API_BASE}/earnings/${endpoint}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    earningsEnabled = data.status.enabled;
                    earningsSymbolsCount = data.status.symbols_count;
                    
                    updateEarningsDisplay();
                    
                    const message = earningsEnabled ? 
                        `‚úÖ Earnings monitoring enabled (${earningsSymbolsCount} symbols)` :
                        'üö´ Earnings monitoring disabled for this week';
                    
                    console.log(message);
                    
                    if (notificationsEnabled) {
                        showNotification('Earnings Monitoring', message, 0);
                    }
                }
            } catch (error) {
                console.error('Error toggling earnings:', error);
            }
        }

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAlertSound(alertType) {
            if (!soundEnabled || !audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            if (alertType.includes('STRONG')) {
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);

                setTimeout(() => {
                    const osc2 = audioContext.createOscillator();
                    const gain2 = audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioContext.destination);
                    osc2.frequency.setValueAtTime(800, audioContext.currentTime);
                    gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    osc2.start(audioContext.currentTime);
                    osc2.stop(audioContext.currentTime + 0.1);
                }, 150);

            } else if (alertType.includes('SHIFT')) {
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);

            } else if (alertType.includes('EXTREME')) {
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.setValueAtTime(1000, audioContext.currentTime);
                        gain.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
                        osc.start(audioContext.currentTime);
                        osc.stop(audioContext.currentTime + 0.08);
                    }, i * 100);
                }

            } else if (!alertType.includes('MONITOR') && !alertType.includes('WAIT')) {
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            }
        }

        function showNotification(symbol, alertType, confidence) {
            if (!notificationsEnabled) return;

            const icon = alertType.includes('BUY') ? 'üü¢' : alertType.includes('SELL') ? 'üî¥' : '‚ö†Ô∏è';
            const title = `${icon} ${symbol} - ${alertType}`;
            const body = confidence ? `Confidence: ${confidence}%` : 'Check dashboard for details';

            if (Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üìä</text></svg>',
                    requireInteraction: false,
                    tag: symbol
                });

                notification.onclick = function() {
                    window.focus();
                    this.close();
                };

                setTimeout(() => notification.close(), 10000);
            }
        }

        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                const permission = await Notification.requestPermission();
                updateNotificationStatus();
                return permission === 'granted';
            }
            return Notification.permission === 'granted';
        }

        function updateNotificationStatus() {
            const statusEl = document.getElementById('notificationStatus');
            if ('Notification' in window && Notification.permission === 'granted') {
                notificationsEnabled = true;
                statusEl.textContent = 'NOTIFICATIONS: ON';
                statusEl.classList.add('enabled');
            } else {
                notificationsEnabled = false;
                statusEl.textContent = 'NOTIFICATIONS: OFF';
                statusEl.classList.remove('enabled');
            }
        }

        document.getElementById('soundToggle').addEventListener('click', function() {
            initAudio();
            soundEnabled = !soundEnabled;
            this.textContent = soundEnabled ? 'üîä SOUND ON' : 'üîá SOUND OFF';
            this.classList.toggle('active', soundEnabled);
        });

        document.getElementById('testAlertBtn').addEventListener('click', function() {
            initAudio();
            playAlertSound('STRONG BUY');
            showNotification('TEST', 'STRONG BUY', 95);
        });

        document.getElementById('refreshBtn').addEventListener('click', loadData);

        function updateTime() {
            const now = new Date();
            const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const timeStr = et.toLocaleTimeString('en-US', { hour12: false });
            document.getElementById('marketTime').textContent = timeStr + ' ET';

            const day = et.getDay();
            const hour = et.getHours();
            const minute = et.getMinutes();
            const currentMinutes = hour * 60 + minute;

            const isWeekday = day >= 1 && day <= 5;
            const marketOpen = 9 * 60 + 30;
            const marketClose = 16 * 60;

            const isOpen = isWeekday && currentMinutes >= marketOpen && currentMinutes < marketClose;

            const statusEl = document.getElementById('marketStatus');
            if (isOpen) {
                statusEl.textContent = 'MARKET OPEN';
                statusEl.className = 'market-status open';
            } else if (isWeekday && currentMinutes >= 4 * 60 && currentMinutes < marketOpen) {
                statusEl.textContent = 'PRE-MARKET';
                statusEl.className = 'market-status open';
            } else {
                statusEl.textContent = 'MARKET CLOSED';
                statusEl.className = 'market-status closed';
            }
        }

        function formatPrice(price) {
            return price > 0 ? `${price.toFixed(2)}` : '--';
        }

        function getVolumeClass(classification) {
            const lowerClass = (classification || 'unknown').toLowerCase();
            return `volume-${lowerClass}`;
        }

        function formatVolumeDisplay(volumeData, isSpike = false) {
            if (!volumeData) {
                return '<span class="volume-unknown">--</span>';
            }
            
            const ratio = isSpike ? (volumeData.spike_ratio || 0) : (volumeData.rvol || 0);
            
            if (ratio === 0) {
                return '<span class="volume-unknown">--</span>';
            }
            
            const classification = volumeData.classification || 'UNKNOWN';
            const direction = volumeData.direction || '';
            const spikeDetected = volumeData.spike_detected || false;
            const cssClass = getVolumeClass(classification);
            
            const spikeEmoji = spikeDetected ? (isSpike ? ' ‚ö°' : ' üî•') : '';
            
            let display = `<span class="${cssClass}">${ratio.toFixed(2)}x${spikeEmoji}<br><small>${classification}</small></span>`;
            
            if (isSpike && direction && direction !== 'NEUTRAL' && direction !== 'UNKNOWN') {
                const dirEmoji = direction === 'BREAKOUT' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                display += `<br><span style="font-size: 9px;">${dirEmoji} ${direction}</span>`;
            }
            
            return display;
        }

        function formatGammaZones(openInterest) {
            if (!openInterest || !openInterest.available) {
                return '<span class="volume-unknown">No data</span>';
            }
            
            const gammaLevels = openInterest.gamma_levels || [];
            const currentPrice = openInterest.current_price || 0;
            const expiresToday = openInterest.expires_today || false;
            const hoursUntil = openInterest.hours_until_expiry || 0;
            const dataSource = openInterest.data_source || 'unknown';
            
            if (gammaLevels.length === 0) {
                return '<span class="volume-unknown">No walls detected</span>';
            }
            
            let html = '<div class="gamma-zone">';
            
            // ENHANCED: Larger expiry info
            if (expiresToday && hoursUntil > 0) {
                html += `<div class="gamma-0dte">‚è∞ 0DTE - ${hoursUntil.toFixed(1)}h LEFT</div>`;
            } else if (expiresToday) {
                html += `<div class="gamma-0dte">üî¥ EXPIRED</div>`;
            } else {
                const expDate = openInterest.expiration || '';
                html += `<div style="color:#888;font-size:10px;font-weight:bold;">Exp: ${expDate}</div>`;
            }
            
            html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
            
            // Sort levels by strike (descending)
            const sortedLevels = [...gammaLevels].sort((a, b) => b.strike - a.strike);
            
            // Find resistance and support
            const resistance = sortedLevels.filter(l => l.strike > currentPrice).slice(0, 2);
            const support = sortedLevels.filter(l => l.strike <= currentPrice).slice(0, 2);
            
            // ENHANCED: Display resistance levels with bigger fonts
            for (const level of resistance) {
                const oiK = (level.total_oi / 1000).toFixed(0);
                const volK = (level.total_volume / 1000).toFixed(0);
                const emoji = level.strength === 'STRONG' ? 'üî¥' : level.strength === 'MODERATE' ? 'üü†' : '‚ö™';
                
                html += `<div class="gamma-resistance" style="margin: 4px 0;">`;
                html += `<span class="gamma-strike-price">${emoji} $${level.strike}</span> `;
                html += `<span class="gamma-label">RESIST</span>`;
                html += `<br><span class="gamma-data resistance-data">OI: ${oiK}K | Vol: ${volK}K</span>`;
                html += `<br><span style="font-size:9px;color:#777;">${level.direction} ${Math.abs(level.distance_pct).toFixed(1)}%</span>`;
                html += `</div>`;
            }
            
            // ENHANCED: Current price - BIGGER
            html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
            html += `<div class="gamma-current">üìç NOW: $${currentPrice.toFixed(2)}</div>`;
            html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
            
            // ENHANCED: Display support levels with bigger fonts
            for (const level of support) {
                const oiK = (level.total_oi / 1000).toFixed(0);
                const volK = (level.total_volume / 1000).toFixed(0);
                const emoji = level.strength === 'STRONG' ? 'üü¢' : level.strength === 'MODERATE' ? 'üü°' : '‚ö™';
                
                html += `<div class="gamma-support" style="margin: 4px 0;">`;
                html += `<span class="gamma-strike-price">${emoji} $${level.strike}</span> `;
                html += `<span class="gamma-label">SUPPORT</span>`;
                html += `<br><span class="gamma-data support-data">OI: ${oiK}K | Vol: ${volK}K</span>`;
                html += `<br><span style="font-size:9px;color:#777;">${level.direction} ${Math.abs(level.distance_pct).toFixed(1)}%</span>`;
                html += `</div>`;
            }
            
            // Expected range
            if (openInterest.expected_range) {
                const range = openInterest.expected_range;
                html += '<div class="gamma-separator">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
                html += `<div style="font-size:10px;color:#999;font-weight:bold;">Range: $${range.low.toFixed(0)}-$${range.high.toFixed(0)}</div>`;
            }
            
            // Data source
            if (dataSource === 'tradier') {
                html += `<div style="font-size:8px;color:#666;margin-top:3px;">üì° Tradier Live</div>`;
            } else if (dataSource === 'polygon_fallback') {
                html += `<div style="font-size:8px;color:#ff6600;margin-top:3px;">‚ö†Ô∏è Fallback Data</div>`;
            }
            
            html += '</div>';
            
            return html;
        }

        function formatDarkPool(darkPoolData) {
            if (!darkPoolData || !darkPoolData.institutional_flow) {
                return '<span class="institutional-neutral">--</span>';
            }
            
            const flow = darkPoolData.institutional_flow;
            const activity = darkPoolData.activity || 'LIGHT';
            const blockValue = darkPoolData.block_trade_value || 0;
            const signalStrength = darkPoolData.signal_strength || 0;
            
            let display = `<span class="institutional-${flow.toLowerCase()}">${flow}</span>`;
            
            if (activity !== 'LIGHT') {
                display += `<br><span style="font-size:9px;color:#666;">${activity}</span>`;
            }
            
            if (blockValue > 10000) {
                const valueMil = (blockValue / 1000000).toFixed(1);
                display += `<br><span style="font-size:9px;color:#ffff00;">$${valueMil}M</span>`;
            }
            
            if (signalStrength > 0) {
                const bars = '‚ñà'.repeat(Math.min(signalStrength, 5));
                display += `<br><span style="font-size:9px;color:#00ff00;">${bars}</span>`;
            }
            
            return display;
        }

        function getAlertClass(alertType) {
            if (!alertType || alertType === 'MONITOR') return 'alert-monitor';
            if (alertType.includes('EXTREME') || alertType.includes('WAIT')) return 'alert-extreme';
            if (alertType.includes('BUY')) return 'alert-buy';
            if (alertType.includes('SELL')) return 'alert-sell';
            if (alertType.includes('SHIFT') || alertType.includes('PROFIT')) return 'alert-tp';
            return 'alert-monitor';
        }

        function getConfidenceClass(confidence) {
            if (confidence >= 75) return 'high';
            if (confidence >= 60) return 'medium';
            return 'low';
        }

        function updateCell(cell, newContent, animated = true) {
            if (cell.innerHTML !== newContent) {
                cell.innerHTML = newContent;
                if (animated && !isFirstLoad) {
                    cell.classList.add('value-changed');
                    setTimeout(() => cell.classList.remove('value-changed'), 500);
                }
            }
        }

        function updateRow(symbol, data) {
            let row = document.querySelector(`tr[data-symbol="${symbol}"]`);
            
            if (!row) {
                const tbody = document.getElementById('tableBody');
                if (tbody.children[0]?.colSpan === 12) {
                    tbody.innerHTML = '';
                }
                row = document.createElement('tr');
                row.setAttribute('data-symbol', symbol);
                row.innerHTML = '<td></td>'.repeat(12);
                tbody.appendChild(row);
            }

            const cells = row.children;
            const camarilla = data.camarilla || {};
            const entryTargets = data.entry_targets || {};
            const premarketVol = data.premarket_rvol || {};
            const volumeAnalysis = data.volume_analysis || {};
            const intradaySpike = volumeAnalysis.volume_spike || {};

            updateCell(cells[0], `<span class="symbol">${data.symbol}</span>`, false);
            updateCell(cells[1], `<span class="price">${formatPrice(data.current_price)}</span>`);
            updateCell(cells[2], `<span class="level">${formatPrice(data.vwap)}</span>`);
            updateCell(cells[3], `<span class="level" style="line-height: 1.4;">R4: ${formatPrice(camarilla.R4)}<br>R3: ${formatPrice(camarilla.R3)}<br>S3: ${formatPrice(camarilla.S3)}<br>S4: ${formatPrice(camarilla.S4)}</span>`);
            updateCell(cells[4], `<span class="level" style="line-height: 1.4;">RES: ${formatPrice(data.resistance)}<br>SUP: ${formatPrice(data.support)}</span>`);
            
            updateCell(cells[5], formatVolumeDisplay(premarketVol, false));
            updateCell(cells[6], formatVolumeDisplay(intradaySpike, true));
            
            updateCell(cells[7], formatDarkPool(data.dark_pool_details || {}));
            
            // ENHANCED: Gamma zones (now much more readable)
            updateCell(cells[8], formatGammaZones(data.open_interest || {}));
            
            updateCell(cells[9], `<span class="news-${(data.news_sentiment || 'neutral').toLowerCase().replace(/\s+/g, '.')}">${data.news_sentiment || '--'}</span>`);
            
            // SHIFTED: Entry/TP/SL now at cells[10]
            const entryInfo = entryTargets.entry ? 
                `E: ${formatPrice(entryTargets.entry)}<br>TP: ${formatPrice(entryTargets.tp1)}<br>SL: ${formatPrice(entryTargets.stop_loss)}` : '--';
            updateCell(cells[10], `<span class="entry-targets" style="line-height: 1.4;">${entryInfo}</span>`);

            // SHIFTED: Alert now at cells[11]
            const alertClass = getAlertClass(data.alert_type);
            const currentAlert = data.alert_type || 'MONITOR';
            const previousAlert = previousAlerts[symbol] || 'MONITOR';
            const isNewAlert = currentAlert !== previousAlert && currentAlert !== 'MONITOR';
            
            const alertContent = `<span class="${alertClass}">${data.alert_type || 'MONITOR'}${data.confidence ? `<br><span class="confidence ${getConfidenceClass(data.confidence)}">${data.confidence.toFixed(0)}%</span>` : ''}</span>`;
            
            if (cells[11].innerHTML !== alertContent) {
                cells[11].innerHTML = alertContent;
                
                if (isNewAlert && !isFirstLoad) {
                    cells[11].classList.add('alert-changed');
                    setTimeout(() => cells[11].classList.remove('alert-changed'), 2000);
                    
                    playAlertSound(currentAlert);
                    showNotification(data.symbol, currentAlert, data.confidence);
                }
            }
            
            previousAlerts[symbol] = currentAlert;
        }

        async function loadData() {
            if (SYMBOLS.length === 0) {
                console.log('‚è≥ Waiting for watchlist to load...');
                return;
            }

            const indicator = document.getElementById('updateIndicator');
            indicator.textContent = 'Updating...';
            indicator.classList.add('updating');

            try {
                const promises = SYMBOLS.map(symbol => 
                    fetch(`${API_BASE}/analyze/${symbol}`)
                        .then(r => r.json())
                        .catch(e => ({ symbol, error: e.message }))
                );

                const results = await Promise.all(promises);
                
                let extremeRegimeDetected = false;
                let regimeMessage = '';
                
                for (const data of results) {
                    if (data.market_regime === 'EXTREME_BEARISH') {
                        extremeRegimeDetected = true;
                        regimeMessage = 'üö® EXTREME BEARISH REGIME DETECTED - MARKET CRASH MODE - NO BUY SIGNALS';
                        break;
                    } else if (data.market_regime === 'EXTREME_BULLISH') {
                        extremeRegimeDetected = true;
                        regimeMessage = 'üö® EXTREME BULLISH REGIME DETECTED - EUPHORIA MODE - NO SELL SIGNALS';
                        break;
                    }
                }
                
                const regimeWarning = document.getElementById('regimeWarning');
                if (extremeRegimeDetected) {
                    regimeWarning.textContent = regimeMessage;
                    regimeWarning.style.display = 'block';
                } else {
                    regimeWarning.style.display = 'none';
                }

                results.forEach(data => {
                    if (!data.error) {
                        updateRow(data.symbol, data);
                    }
                });

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
                indicator.textContent = `Updated: ${timeStr}`;
                indicator.classList.remove('updating');
                
                isFirstLoad = false;

            } catch (error) {
                indicator.textContent = 'Update failed';
                indicator.classList.remove('updating');
                console.error('Error loading data:', error);
            }
        }

        async function initialize() {
            console.log('üöÄ Initializing Professional Trading Dashboard v4.2 - ENHANCED GAMMA');
            
            await loadWatchlist();
            await loadEarningsStatus();
            
            setInterval(updateTime, 1000);
            updateTime();
            updateNotificationStatus();

            await loadData();
            
            setInterval(loadData, 30000);
            setInterval(loadEarningsStatus, 60000);

            setTimeout(() => {
                if ('Notification' in window && Notification.permission === 'default') {
                    requestNotificationPermission();
                }
            }, 2000);
            
            console.log('‚úÖ Dashboard initialized with', SYMBOLS.length, 'symbols');
            console.log(`üìÖ Earnings monitoring: ${earningsEnabled ? 'ENABLED' : 'DISABLED'} (${earningsSymbolsCount} symbols)`);
            console.log('üí° Enhanced Gamma Zones: 85% larger + improved readability');
            console.log('üéØ 0DTE gamma pinning detection active');
        }

        initialize();
    </script>
</body>
</html>